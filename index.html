<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Produção</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      --bg-color: #f5f5f5;
      --text-color: #333;
      --muted-color: #6b6b6b;
      --card-bg: rgba(255,255,255,0.04 ); /* Changed from #fff to better match the original intention */
      --grid-color: rgba(0,0,0,0.04);
      --primary-color: #007bff;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { color: var(--primary-color); }
    .chart-title { font-size: 1.05rem; color: var(--text-color); margin: 6px 0 8px; text-align: center; font-weight: 600; }
    body.dark {
      --bg-color: #0f1720;
      --text-color: #e6eef8;
      --muted-color: #9aa6b2;
      --card-bg: rgba(255,255,255,0.03);
      --grid-color: rgba(255,255,255,0.06);
      --primary-color: #66b0ff;
    }
    #themeToggle {
      margin-top: 6px; padding: 6px 10px;
      border-radius: 6px; border: 1px solid rgba(0,0,0,0.06);
      background: transparent; color: var(--text-color);
      cursor: pointer; font-weight: 600;
    }
    #themeToggle:hover { background: rgba(0,0,0,0.08); }
    .chart-card { max-width: none; width: 100%; margin-top: 30px; padding: 12px; border-radius: 10px; background: transparent; display: flex; justify-content: center; }
    .charts-row { display: flex; gap: 18px; width: 100%; max-width: 1200px; align-items: flex-start; flex-wrap: wrap; justify-content: center; }
    .charts-row > .chart-card { flex: 1 1 48%; box-sizing: border-box; }
    canvas { width: 100% !important; max-width: none; height: 360px !important; border-radius: 6px; background: transparent; }
  </style>
</head>
<body>
  <h1>Dashboard de Produção</h1>
  <button id="themeToggle">Modo escuro</button>

  <div class="charts-row">
    <div class="chart-card">
      <div style="width:100%;">
        <h2 class="chart-title">Produção diária por setor</h2>
        <canvas id="graficoProducaoDiaria"></canvas> <!-- Changed ID for clarity -->
      </div>
    </div>
    <div class="chart-card">
      <div style="width:100%;">
        <h2 class="chart-title">Expedição anual (comparativo de anos)</h2>
        <canvas id="graficoExpedicao"></canvas>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://indicadores-fabrica.onrender.com";

    function hexToRGBA(hex, alpha ) {
      if (!hex) return `rgba(0,0,0,${alpha})`;
      const h = hex.replace('#','').trim();
      if (h.length === 3) {
        const r = parseInt(h[0]+h[0],16);
        const g = parseInt(h[1]+h[1],16);
        const b = parseInt(h[2]+h[2],16);
        return `rgba(${r},${g},${b},${alpha})`;
      }
      const r = parseInt(h.substring(0,2),16);
      const g = parseInt(h.substring(2,4),16);
      const b = parseInt(h.substring(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function getThemeVars() {
      const s = getComputedStyle(document.body);
      const primary = (s.getPropertyValue('--primary-color') || '#007bff').trim();
      const text = (s.getPropertyValue('--text-color') || '#333').trim();
      const muted = (s.getPropertyValue('--muted-color') || '#6b6b6b').trim();
      const grid = (s.getPropertyValue('--grid-color') || 'rgba(0,0,0,0.04)').trim();
      const bg = (s.getPropertyValue('--bg-color') || '#f5f5f5').trim();
      const cardBg = (s.getPropertyValue('--card-bg') || '#fff').trim();
      return { primary, text, muted, grid, bg, cardBg };
    }

    // Global chart instances to allow destruction and recreation
    let _graficoProducaoDiaria;
    let _graficoExpedicao;

    async function carregarProducaoDiaria() {
        try {
            const resp = await fetch(`${API_BASE}/producao_diaria_por_setor`); // Adjust endpoint as needed
            if (!resp.ok) {
                throw new Error(`Erro HTTP: ${resp.status}`);
            }
            const dados = await resp.json();

            if (!dados || !Array.isArray(dados) || dados.length === 0) {
                console.warn('Nenhum dado de produção diária retornado pela API.');
                // Render an empty chart or a message if no data
                if (_graficoProducaoDiaria) _graficoProducaoDiaria.destroy();
                const ctx = document.getElementById('graficoProducaoDiaria').getContext('2d');
                _graficoProducaoDiaria = new Chart(ctx, {
                    type: 'bar', // Or 'line', depending on your preference
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                return;
            }

            const ctx = document.getElementById('graficoProducaoDiaria').getContext('2d');
            const theme = getThemeVars();

            // Example data processing for "Produção diária por setor"
            // Assuming data is like: [{ setor: "A", data: "YYYY-MM-DD", valor: 100 }, ...]
            const setores = [...new Set(dados.map(d => d.setor))].sort();
            const datas = [...new Set(dados.map(d => d.data))].sort(); // Assuming 'data' is a string 'YYYY-MM-DD'

            const cores = [theme.primary, "#28a745", "#dc3545", "#ffc107", "#17a2b8", "#6f42c1"]; 

            const datasets = setores.map((setor, i) => {
                const dataPoints = datas.map(data => {
                    const entry = dados.find(d => d.setor === setor && d.data === data);
                    return entry ? Number(entry.valor) : 0;
                });
                return {
                    label: setor,
                    data: dataPoints,
                    backgroundColor: hexToRGBA(cores[i % cores.length], 0.7),
                    borderColor: cores[i % cores.length],
                    borderWidth: 1
                };
            });

            if (_graficoProducaoDiaria) _graficoProducaoDiaria.destroy();

            _graficoProducaoDiaria = new Chart(ctx, {
                type: 'bar', // Can be 'line' or 'bar'
                data: { labels: datas, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, labels: { color: theme.text } } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: theme.grid },
                            ticks: { color: theme.muted }
                        },
                        x: {
                            grid: { color: theme.grid },
                            ticks: { color: theme.muted }
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Erro ao carregar produção diária:', e);
        }
    }


    async function carregarExpedicao() {
      try {
        const resp = await fetch(`${API_BASE}/expedicao_anual`);
        
        if (!resp.ok) {
            throw new Error(`Erro HTTP: ${resp.status}`);
        }
        
        const dados = await resp.json();
        
        if (!dados || !Array.isArray(dados) || dados.length === 0) {
            console.warn('Nenhum dado de expedição retornado pela API.');
            // Render an empty chart or a message if no data
            if (_graficoExpedicao) _graficoExpedicao.destroy();
            const ctx2 = document.getElementById('graficoExpedicao').getContext('2d');
            _graficoExpedicao = new Chart(ctx2, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            return;
        }

        const ctx2 = document.getElementById('graficoExpedicao').getContext('2d');
        const theme = getThemeVars();

        const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

        const anosSet = new Set();
        dados.forEach(d => {
          const dt = new Date(d.mes);
          if (!isNaN(dt.getTime())) { // Check for valid date
              anosSet.add(dt.getFullYear());
          } else {
              console.warn(`Data inválida encontrada: ${d.mes}`);
          }
        });
        const anos = Array.from(anosSet).sort();

        const valoresPorAno = {};
        anos.forEach(a => valoresPorAno[a] = Array(12).fill(0));

        dados.forEach(d => {
          const dt = new Date(d.mes);
          if (!isNaN(dt.getTime())) {
            const ano = dt.getFullYear();
            const mesIndex = dt.getMonth();
            if (valoresPorAno[ano] && d.valor !== undefined && d.valor !== null) {
                valoresPorAno[ano][mesIndex] = Number(d.valor);
            }
          }
        });

        const cores = [theme.primary, "#28a745", "#dc3545", "#ffc107", "#17a2b8"]; 
        
        const datasets = anos.map((ano, i) => ({
          label: ano.toString(),
          data: valoresPorAno[ano],
          borderColor: cores[i % cores.length],
          backgroundColor: hexToRGBA(cores[i % cores.length], 0.1),
          fill: true,
          tension: 0.3
        }));

        if (_graficoExpedicao) _graficoExpedicao.destroy();

        _graficoExpedicao = new Chart(ctx2, {
          type: 'line',
          data: { labels: meses, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, labels: { color: theme.text } } },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: theme.grid },
                    ticks: { color: theme.muted }
                },
                x: {
                    grid: { color: theme.grid },
                    ticks: { color: theme.muted }
                }
            }
          }
        });

      } catch(e) {
        console.error('Erro ao carregar expedição:', e);
      }
    }

    // Carrega dados
    carregarProducaoDiaria(); // Call the new function
    carregarExpedicao();

    // Tema escuro
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(isDark) {
      document.body.classList.toggle('dark', isDark);
      themeToggle.textContent = isDark ? 'Modo claro' : 'Modo escuro';
      carregarProducaoDiaria(); // Recarrega os gráficos para aplicar as novas cores do tema
      carregarExpedicao();
    }
    const saved = localStorage.getItem('themeDark') === '1';
    applyTheme(saved);

    themeToggle.addEventListener('click', ()=>{
      const isDark = !document.body.classList.contains('dark');
      localStorage.setItem('themeDark', isDark ? '1' : '0');
      applyTheme(isDark);
    });
  </script>
</body>
</html>
