<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Produ√ß√£o</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      --bg-color: #f5f5f5;
      --text-color: #333;
      --muted-color: #6b6b6b;
      --card-bg: rgba(255,255,255,0.04);
      --grid-color: rgba(0,0,0,0.04);
      --primary-color: #007bff;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { color: #007bff; }
    .chart-title { font-size: 1.05rem; color: var(--text-color); margin: 6px 0 8px; text-align: center; font-weight: 600; }
    body.dark { --bg-color: #0f1720; --text-color: #e6eef8; --muted-color: #9aa6b2; --card-bg: rgba(255,255,255,0.03); --grid-color: rgba(255,255,255,0.06); --primary-color: #66b0ff; }
    #themeToggle { margin-top:6px; padding:6px 10px; border-radius:6px; border:1px solid var(--btn-border); background: var(--btn-bg); color: var(--btn-text); cursor:pointer; font-weight:600; }
    .chart-card { max-width:none; width:100%; margin-top:30px; padding:12px; border-radius:10px; background:transparent; display:flex; justify-content:center; }
    .charts-row { display:flex; gap:18px; width:100%; max-width:1200px; align-items:flex-start; flex-wrap:wrap; justify-content:center; }
    .charts-row > .chart-card { flex:1 1 48%; box-sizing:border-box; }
    canvas { width:100% !important; max-width:none; height:360px !important; background:transparent; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Dashboard de Produ√ß√£o</h1>
  <button id="themeToggle">Modo escuro</button>

  <div class="charts-row">
    <div class="chart-card">
      <div style="width:100%;">
        <h2 class="chart-title">Produ√ß√£o di√°ria por setor semana anterior</h2>
        <canvas id="grafico"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div style="width:100%;">
        <h2 class="chart-title">Expedi√ß√£o mensal em toneladas</h2>
        <canvas id="graficoExpedicao"></canvas>
      </div>
    </div>
  </div>

  <script>
    // üîπ URL da API online
    const API_BASE = "https://indicadores-fabrica.onrender.com";

    function getThemeVars() {
      const s = getComputedStyle(document.body);
      const primary = (s.getPropertyValue('--primary-color') || '#007bff').trim();
      const text = (s.getPropertyValue('--text-color') || '#333').trim();
      const muted = (s.getPropertyValue('--muted-color') || '#6b6b6b').trim();
      const grid = (s.getPropertyValue('--grid-color') || 'rgba(0,0,0,0.04)').trim();
      const bg = (s.getPropertyValue('--bg-color') || '#f5f5f5').trim();
      const cardBg = (s.getPropertyValue('--card-bg') || '#fff').trim();
      const isDark = document.body.classList.contains('dark');
      return { primary, text, muted, grid, bg, cardBg, isDark };
    }

    function hexToRGBA(hex, alpha) {
      if (!hex) return `rgba(0,0,0,${alpha})`;
      const h = hex.replace('#','').trim();
      if (h.length === 3) { const r=parseInt(h[0]+h[0],16); const g=parseInt(h[1]+h[1],16); const b=parseInt(h[2]+h[2],16); return `rgba(${r},${g},${b},${alpha})`; }
      const r=parseInt(h.substring(0,2),16); const g=parseInt(h.substring(2,4),16); const b=parseInt(h.substring(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    async function carregarDados() {
      try {
        const response = await fetch(API_BASE + '/producao');
        const dados = await response.json();

        const ctx = document.getElementById('grafico').getContext('2d');
        const setores = dados.map(d => d.setor);
        const pesos = dados.map(d => d.peso);

        const coresPorSetor = {
          "laminacao": "#007bff",
          "corte": "#28a745",
          "expedicao": "#dc3545",
          "tempera": "#ffc107",
          "lapidacao": "#17a2b8"
        };
        const cores = setores.map(setor => coresPorSetor[setor.toLowerCase()] || "#6c757d");

        if (window._graficoInstance) { window._graficoInstance.destroy(); window._graficoInstance=null; }

        const theme = getThemeVars();
        const coresSutis = cores.map(c=>hexToRGBA(c,0.75));

        window._graficoInstance = new Chart(ctx,{
          type:'bar',
          data:{ labels:setores, datasets:[{label:'Peso', data:pesos, backgroundColor:coresSutis, borderRadius:8, borderSkipped:false, barPercentage:0.6, categoryPercentage:0.6}] },
          options:{ responsive:true, maintainAspectRatio:false, layout:{padding:{top:6,bottom:6,left:6,right:6}}, plugins:{legend:{display:false}, title:{display:false}, tooltip:{backgroundColor:theme.isDark?'#111827':'#fff', titleColor:theme.text, bodyColor:theme.text, borderColor:theme.isDark?'rgba(255,255,255,0.06)':'#e9e9e9', borderWidth:1, padding:10}} , scales:{ x:{grid:{display:false},ticks:{color:theme.muted}}, y:{grid:{color:theme.grid},ticks:{color:theme.muted, beginAtZero:true}}}, animation:{duration:700, easing:'easeOutQuart'}, interaction:{mode:'index', intersect:false} }
        });
      } catch (erro) { console.error('Erro ao carregar dados:', erro); }
    }

    async function carregarExpedicaoAnual() {
      try {
        const resp = await fetch(API_BASE + '/expedicao_anual');
        const dados = await resp.json();

        if (!dados || dados.length === 0) return;

        const ctx2 = document.getElementById('graficoExpedicao').getContext('2d');
        if (window._graficoExpedicao) { window._graficoExpedicao.destroy(); window._graficoExpedicao=null; }

        const months = Array.from({length:12}, (_,i)=>new Date(2000,i,1).toLocaleString('pt-BR',{month:'short'}));
        const entries = dados.map(r => ({ d: new Date(r.mes), valor: Number(r.valor || 0) }));

        const mapYear = new Map();
        entries.forEach(e=>{ const y=e.d.getFullYear(), m=e.d.getMonth(); if(!mapYear.has(y)) mapYear.set(y, Array(12).fill(null)); mapYear.get(y)[m]=e.valor; });

        const years = Array.from(mapYear.keys()).sort();
        const theme2 = getThemeVars();

        const datasets = years.map((y, idx) => {
          const data = mapYear.get(y).map(v=>v===0?null:v);
          const isCurrent = y===new Date().getFullYear();
          const baseColor = isCurrent ? theme2.primary : ['#6c757d','#17a2b8','#28a745','#ffc107'][idx%4];
          return { label:String(y), data, borderColor:baseColor, borderWidth:isCurrent?3:2, backgroundColor:hexToRGBA(baseColor,0.08), tension:0.3, fill:true };
        });

        window._graficoExpedicao = new Chart(ctx2, { type:'line', data:{labels:months,datasets:datasets}, options:{ responsive:true, maintainAspectRatio:false } });

      } catch(err) { console.error('Erro ao carregar expedi√ß√£o anual', err); }
    }

    carregarDados();
    carregarExpedicaoAnual();

    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(isDark) {
      document.body.classList.toggle('dark', isDark);
      themeToggle.textContent = isDark ? 'Modo claro' : 'Modo escuro';
      carregarDados();
      carregarExpedicaoAnual();
    }
    const saved = localStorage.getItem('themeDark');
    applyTheme(saved==='1');

    themeToggle.addEventListener('click',()=>{
      const isDark = !document.body.classList.contains('dark');
      localStorage.setItem('themeDark', isDark?'1':'0');
      applyTheme(isDark);
    });
  </script>
</body>
</html>
