<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Produ√ß√£o</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
  --bg-color: #f5f5f5;
  --text-color: #333;
  --muted-color: #6b6b6b;
  --card-bg: rgba(255,255,255,0.04);
  --grid-color: rgba(0,0,0,0.04);
  --primary-color: #007bff;

      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      color: #007bff;
    }
    .chart-title {
      font-size: 1.05rem;
      color: var(--text-color);
      margin: 6px 0 8px;
      text-align: center;
      font-weight: 600;
      text-transform: none;
    }
    /* tema escuro */
    body.dark {
      --bg-color: #0f1720;
      --text-color: #e6eef8;
      --muted-color: #9aa6b2;
      --card-bg: rgba(255,255,255,0.03);
      --grid-color: rgba(255,255,255,0.06);
      --primary-color: #66b0ff;
    }
    /* bot√£o de tema (usa vari√°veis para adaptar ao tema) */
    :root {
      --btn-bg: transparent;
      --btn-border: rgba(0,0,0,0.06);
      --btn-text: var(--text-color);
      --btn-hover-bg: rgba(0,0,0,0.03);
    }
    body.dark {
      --btn-bg: rgba(255,255,255,0.02);
      --btn-border: rgba(255,255,255,0.12);
      --btn-text: var(--text-color);
      --btn-hover-bg: rgba(255,255,255,0.03);
    }
    #themeToggle {
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      cursor: pointer;
      font-weight: 600;
    }
    #themeToggle:hover {
      background: var(--btn-hover-bg);
    }
    /* Container for a clean chart card */
    .chart-card {
      /* let flex parent control width */
      max-width: none;
      width: 100%;
      margin-top: 30px;
      padding: 12px;
      border-radius: 10px;
      background: transparent; /* keep page background visible for a cleaner look */
      box-shadow: none;
      display: flex;
      justify-content: center;
    }

    /* row to place charts side-by-side */
    .charts-row {
      display: flex;
      gap: 18px;
      width: 100%;
      max-width: 1200px;
      align-items: flex-start;
      flex-wrap: wrap;
      justify-content: center;
    }
    .charts-row > .chart-card {
      flex: 1 1 48%;
      box-sizing: border-box;
    }
    canvas {
      width: 100% !important;
      max-width: none;
      height: 360px !important;
      background: transparent;
      border-radius: 6px;
    }
    table {
      margin-top: 30px;
      border-collapse: collapse;
      width: 720px;
      background: transparent;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid #f0f0f0;
      padding: 10px;
      text-align: left;
      color: var(--text-color);
    }
    th {
      background: transparent;
      color: var(--muted-color);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Dashboard de Produ√ß√£o</h1>
  <button id="themeToggle" style="margin-top:6px; padding:6px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); background:transparent; cursor:pointer;">Modo escuro</button>

  <div class="charts-row">
    <div class="chart-card">
      <div style="width:100%;">
        <h2 class="chart-title">Produ√ß√£o diaria por setor semana anterior</h2>
        <canvas id="grafico"></canvas>
      </div>
    </div>

    <!-- Novo gr√°fico: evolu√ß√£o anual da expedi√ß√£o -->
    <div class="chart-card">
      <div style="width:100%;">
        <h2 class="chart-title">Expedi√ß√£o mensal em toneladas </h2>
        <canvas id="graficoExpedicao"></canvas>
      </div>
    </div>
  </div>

  <!-- tabela de indicadores removida -->

  <script>
      // helper para resolver base da API automaticamente
      function getApiBase() {
        // se a p√°gina estiver sendo servida (http/https), usa o mesmo host; sen√£o (file:) usa localhost
        const host = (location.hostname && location.hostname !== '') ? location.hostname : '127.0.0.1';
        const proto = (location.protocol && location.protocol !== 'file:') ? location.protocol : 'http:';
        return proto + '//' + host + ':5000';
      }
    // helpers para tema e cores
    function getThemeVars() {
      const s = getComputedStyle(document.body);
      const primary = (s.getPropertyValue('--primary-color') || '#007bff').trim();
      const text = (s.getPropertyValue('--text-color') || '#333').trim();
      const muted = (s.getPropertyValue('--muted-color') || '#6b6b6b').trim();
      const grid = (s.getPropertyValue('--grid-color') || 'rgba(0,0,0,0.04)').trim();
      const bg = (s.getPropertyValue('--bg-color') || '#f5f5f5').trim();
      const cardBg = (s.getPropertyValue('--card-bg') || '#fff').trim();
      const isDark = document.body.classList.contains('dark');
      return { primary, text, muted, grid, bg, cardBg, isDark };
    }

    function hexToRGBA(hex, alpha) {
      if (!hex) return `rgba(0,0,0,${alpha})`;
      const h = hex.replace('#','').trim();
      if (h.length === 3) {
        const r = parseInt(h[0]+h[0],16);
        const g = parseInt(h[1]+h[1],16);
        const b = parseInt(h[2]+h[2],16);
        return `rgba(${r},${g},${b},${alpha})`;
      }
      const r = parseInt(h.substring(0,2),16);
      const g = parseInt(h.substring(2,4),16);
      const b = parseInt(h.substring(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    async function carregarDados() {
      try {
        // üîπ Altere o IP abaixo para o IP da M√ÅQUINA onde est√° a API Flask
    // üîπ A URL da API √© resolvida automaticamente; altere apenas se necess√°rio
    const response = await fetch(getApiBase() + '/producao');
        const dados = await response.json();

        // ---- Anteriormente exibia na tabela; agora loga os dados no console ----
        console.debug('dados de producao:', dados);

  // ---- Criar gr√°fico ----
  const ctx = document.getElementById('grafico').getContext('2d');
        const setores = dados.map(d => d.setor);
        const pesos = dados.map(d => d.peso);

        // ---- Mapa de cores fixas por setor ----
        const coresPorSetor = {
          "laminacao": "#007bff",
          "corte": "#28a745",
          "expedicao": "#dc3545",
          "tempera": "#ffc107",
          "lapidacao": "#17a2b8"
        };

        // Se algum setor n√£o estiver no mapa, usa uma cor padr√£o
        const cores = setores.map(setor => coresPorSetor[setor.toLowerCase()] || "#6c757d");

        // Se j√° existe um gr√°fico, destr√≥i para evitar sobreposi√ß√£o ao recarregar
        if (window._graficoInstance) {
          window._graficoInstance.destroy();
          window._graficoInstance = null;
        }
        // aplica tema nas cores do chart
        const theme = getThemeVars();
        const coresSutis = cores.map(c => hexToRGBA(c, 0.75));

        window._graficoInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: setores,
            datasets: [{
              label: 'Peso',
              data: pesos,
              backgroundColor: coresSutis,
              borderRadius: 8,
              borderSkipped: false,
              barPercentage: 0.6,
              categoryPercentage: 0.6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 6, bottom: 6, left: 6, right: 6 } },
            plugins: {
              legend: { display: false },
              title: { display: false }, // ocultar t√≠tulo para visual mais limpo
              tooltip: {
                backgroundColor: theme.isDark ? '#111827' : '#fff',
                titleColor: theme.text,
                bodyColor: theme.text,
                borderColor: theme.isDark ? 'rgba(255,255,255,0.06)' : '#e9e9e9',
                borderWidth: 1,
                padding: 10,
                boxPadding: 6,
                boxWidth: 10,
                callbacks: {
                  label: function(context) {
                    const v = context.parsed.y ?? context.parsed;
                    return 'Peso: ' + Number(v).toLocaleString('pt-BR');
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: theme.muted }
              },
              y: {
                grid: { color: theme.grid },
                ticks: {
                  color: theme.muted,
                  beginAtZero: true,
                  callback: function(value) { return Number(value).toLocaleString('pt-BR'); }
                }
              }
            },
            animation: { duration: 700, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false }
          }
        });
      } catch (erro) {
        alert("Erro ao carregar dados: " + erro);
        console.error(erro);
      }
    }

    carregarDados();

    // ---------------- gr√°fico da expedi√ß√£o anual ----------------
    async function carregarExpedicaoAnual() {
      try {
    const resp = await fetch(getApiBase() + '/expedicao_anual');
        const dados = await resp.json();

        // os campos na tabela s√£o: `mes` (primeiro dia do m√™s ou n√∫mero do m√™s) e `peso`
        if (!dados || dados.length === 0) {
          console.warn('Nenhum dado retornado para expedi√ß√£o anual');
          return;
        }

        const dateKey = 'mes';
        const valorKey = 'valor';

        function parseToDate(v) {
          if (v == null) return null;
          // n√∫mero do m√™s 1..12
          const n = Number(v);
          if (!isNaN(n) && n >= 1 && n <= 12) return new Date(2000, n - 1, 1);

          // ISO yyyy-mm-dd
          if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}/.test(v)) {
            const parts = v.split('T')[0].split('-');
            return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
          }

          // dd/mm/yyyy
          if (typeof v === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)) {
            const parts = v.split('/');
            return new Date(Number(parts[2]), Number(parts[1]) - 1, Number(parts[0]));
          }

          // tenta Date do JS
          const dt = new Date(v);
          return dt.toString() === 'Invalid Date' ? null : dt;
        }

        // monta array com datas parseadas e valores
        const entries = dados.map(r => {
          return {
            raw: r,
            d: parseToDate(r[dateKey]),
            valor: (r[valorKey] == null) ? 0 : Number(r[valorKey])
          };
        });

        console.log('expedicao raw:', dados);
        console.log('expedicao parsed entries:', entries);

        // se temos datas parseadas, agrupamos por ano e montamos uma linha por ano (jan..dez)
        const anyDate = entries.some(e => e.d instanceof Date && !isNaN(e.d));
        const ctx2 = document.getElementById('graficoExpedicao').getContext('2d');

        if (window._graficoExpedicao) {
          window._graficoExpedicao.destroy();
          window._graficoExpedicao = null;
        }

        const theme2 = getThemeVars();
        const highlightThreshold = 700;
        const highlightColor = '#27F531';

        if (anyDate) {
          // meses fixos (jan..dec)
          const months = Array.from({length:12}, (_,i) => new Date(2000,i,1).toLocaleString('pt-BR',{month:'short'}));

          // agrupa valores por ano e m√™s
          const mapYear = new Map();
          entries.forEach(e => {
            if (!e.d) return;
            const y = e.d.getFullYear();
            const m = e.d.getMonth();
            if (!mapYear.has(y)) mapYear.set(y, Array(12).fill(null));
            mapYear.get(y)[m] = isNaN(e.valor) ? 0 : e.valor;
          });

          const years = Array.from(mapYear.keys()).sort();

          // palette for non-current years
          const pal = [ '#6c757d', '#17a2b8', '#28a745', '#ffc107' ];
          const currentYear = new Date().getFullYear();

          const datasets = years.map((y, idx) => {
            // tratar zeros como aus√™ncia para quebrar a linha
            const data = mapYear.get(y).map(v => (v == null || Number(v) === 0) ? null : v);
            const isCurrent = Number(y) === currentYear;
            const baseColor = isCurrent ? theme2.primary : (pal[idx % pal.length]);
            const defaultPointBg = theme2.isDark ? theme2.bg : '#fff';
            const pointBg = data.map(v => (v != null && v > highlightThreshold) ? highlightColor : defaultPointBg);
            const pointBorder = data.map(v => (v != null && v > highlightThreshold) ? highlightColor : baseColor);
            const pointR = data.map(v => (v != null && v > highlightThreshold) ? 6 : (isCurrent ? 5 : 4));
            const pointBw = data.map(v => (v != null && v > highlightThreshold) ? 3 : (isCurrent ? 3 : 2));

            return {
              label: String(y),
              data: data,
              borderColor: baseColor,
              borderWidth: isCurrent ? 3 : 2,
              backgroundColor: hexToRGBA(baseColor, 0.08),
              tension: 0.3,
              pointRadius: pointR,
              pointBackgroundColor: pointBg,
              pointBorderColor: pointBorder,
              pointBorderWidth: pointBw,
              fill: true
            };
          });

          window._graficoExpedicao = new Chart(ctx2, {
            type: 'line',
            data: { labels: months, datasets: datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              elements: { point: { hitRadius: 15, hoverRadius: 10 } },
              interaction: { mode: 'nearest', axis: 'x', intersect: true },
              plugins: { legend: { display: true }, tooltip: { backgroundColor: theme2.isDark ? '#111827' : '#fff', titleColor: theme2.text, bodyColor: theme2.text, borderColor: theme2.isDark ? 'rgba(255,255,255,0.06)' : '#e9e9e9' } },
              scales: { x: { grid: { display: false }, ticks: { color: theme2.muted } }, y: { grid: { color: theme2.grid }, ticks: { color: theme2.muted } } }
            }
          });
        } else {
          // fallback: dados sem datas - usa labels diretas e uma √∫nica linha
          const labels = dados.map(r => String(r[dateKey]));
          // tratar zeros como aus√™ncia (null) para quebrar a linha
          const valores = dados.map(r => { const n = Number(r[valorKey]); return isNaN(n) ? null : (n === 0 ? null : n); });
          const defaultPointBg = theme2.isDark ? theme2.bg : '#fff';
          const pointBgColors = valores.map(v => (v != null && v > highlightThreshold) ? highlightColor : defaultPointBg);
          const pointBorderColors = valores.map(v => (v != null && v > highlightThreshold) ? highlightColor : theme2.primary);
          const pointRadii = valores.map(v => (v != null && v > highlightThreshold) ? 6 : 4);
          const pointBorderWidths = valores.map(v => (v != null && v > highlightThreshold) ? 3 : 2);

          window._graficoExpedicao = new Chart(ctx2, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Expedi√ß√£o (mensal)', data: valores, borderColor: theme2.primary, backgroundColor: hexToRGBA(theme2.primary,0.08), tension:0.3, pointRadius: pointRadii, pointBackgroundColor: pointBgColors, pointBorderColor: pointBorderColors, pointBorderWidth: pointBorderWidths, spanGaps: false, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, elements: { point: { hitRadius: 20, hoverRadius: 12 } }, interaction: { mode: 'nearest', axis: 'x', intersect: true }, plugins: { legend: { display: false }, tooltip: { backgroundColor: theme2.isDark ? '#111827' : '#fff', titleColor: theme2.text, bodyColor: theme2.text, borderColor: theme2.isDark ? 'rgba(255,255,255,0.06)' : '#e9e9e9' } }, scales: { x: { grid: { display: false }, ticks: { color: theme2.muted } }, y: { grid: { color: theme2.grid }, ticks: { color: theme2.muted } } } }
          });
        }

      } catch (err) {
        console.error('Erro ao carregar expedi√ß√£o anual', err);
      }
    }

    carregarExpedicaoAnual();

    // ---- tema escuro ----
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(isDark) {
      document.body.classList.toggle('dark', isDark);
      themeToggle.textContent = isDark ? 'Modo claro' : 'Modo escuro';

      // reconstruir os gr√°ficos para reaplicar cores do tema
      try { carregarDados(); } catch(e) { console.warn(e); }
      try { carregarExpedicaoAnual(); } catch(e) { console.warn(e); }
    }

    // carrega prefer√™ncia do localStorage
    const saved = localStorage.getItem('themeDark');
    const isDarkSaved = saved === '1';
    applyTheme(isDarkSaved);

    themeToggle.addEventListener('click', () => {
      const isDark = !document.body.classList.contains('dark');
      localStorage.setItem('themeDark', isDark ? '1' : '0');
      applyTheme(isDark);
    });
  </script>
</body>
</html>
